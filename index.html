<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP Contact Form - Bitcoin Policy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-2 text-orange-700">Contact Your MP About Bitcoin Policy</h1>
        <p class="text-gray-600 mb-6">Make your voice heard</p>

        <form id="mpContactForm" class="space-y-6">
            <!-- Personal Information Section -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">Your Information</h2>
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Full Name *</label>
                        <input type="text" id="name" name="name" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 px-3 py-2"
                            placeholder="Your full name">
                        <p id="nameError" class="hidden text-red-500 text-sm mt-1">Please enter your full name</p>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address *</label>
                        <input type="email" id="email" name="email" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 px-3 py-2"
                            placeholder="your.email@example.com">
                        <p id="emailError" class="hidden text-red-500 text-sm mt-1">Please enter a valid email address</p>
                    </div>

                    <div>
                        <label for="postcode" class="block text-sm font-medium text-gray-700">Postcode *</label>
                        <input type="text" id="postcode" name="postcode" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 px-3 py-2"
                            placeholder="e.g., SW1A 1AA">
                        <p id="postcodeError" class="hidden text-red-500 text-sm mt-1">Please enter a valid UK postcode</p>
                    </div>

                    <div>
                        <h3 class="text-sm font-medium text-gray-700">Select a policy issue to contact your MP about:</h3>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="cbdcPolicy" name="policy" type="radio" value="CBDC Policy" required
                                    class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                                <label for="cbdcPolicy" class="ml-2 block text-sm text-gray-900">CBDC Policy</label>
                            </div>
                            <div class="flex items-center">
                                <input id="btcPolicy" name="policy" type="radio" value="BTC Policy"
                                    class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                                <label for="btcPolicy" class="ml-2 block text-sm text-gray-900">BTC Policy</label>
                            </div>
                            <div class="flex items-center">
                                <input id="taxPolicy" name="policy" type="radio" value="Tax Policy"
                                    class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                                <label for="taxPolicy" class="ml-2 block text-sm text-gray-900">Tax Policy</label>
                            </div>
                        </div>
                        <p id="policyError" class="hidden text-red-500 text-sm mt-1">Please select a policy issue</p>
                    </div>
                </div>
            </div>

            <!-- Find My MP Button -->
            <button type="submit" id="findMpButton"
                class="w-full bg-orange-600 text-white py-3 px-4 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors disabled:bg-gray-400">
                Find My MP
            </button>

            <!-- MP Information Display -->
            <div id="mpInfo" class="hidden bg-orange-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Your MP</h2>
                <p id="mpDetails" class="text-gray-800"></p>
                <button id="contactMpButton" 
                    class="mt-4 w-full bg-orange-600 text-white py-3 px-4 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors disabled:bg-gray-400 hidden">
                    Contact My MP
                </button>
                <p id="emailLinkContainer" class="mt-4 hidden">
                    <a id="emailLink" href="#" target="_blank" class="text-orange-600 hover:text-orange-700">Click here to email your MP</a>
                </p>
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById('mpContactForm');
        const mpInfo = document.getElementById('mpInfo');
        const mpDetails = document.getElementById('mpDetails');
        const emailLink = document.getElementById('emailLink');
        const emailLinkContainer = document.getElementById('emailLinkContainer');
        const findMpButton = document.getElementById('findMpButton');
        const contactMpButton = document.getElementById('contactMpButton');

        // Prepopulated letters (placeholders)
        const letters = {
            "CBDC Policy": `I am writing to express my concerns about Central Bank Digital Currencies (CBDCs). I believe CBDCs pose significant risks to financial privacy and individual freedoms. The potential for government surveillance through transaction tracking is alarming, and the centralization of financial control could undermine economic resilience. I urge you to oppose the development and implementation of CBDCs in the UK and advocate for policies that protect decentralized financial systems.`,
            "BTC Policy": `[Placeholder: Insert letter about BTC Policy here]`,
            "Tax Policy": `[Placeholder: Insert letter about Tax Policy here]`
        };

        // CSV URL from Google Sheets
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRWw-EUwnZUANlr2AgEgpOAN8ExWAPae5dmLFVGy7g2fzJsHDJXbfZ9SWSQghCSLlZgpOrpSDNhP6Sb/pub?gid=908878639&single=true&output=csv';

        // Validation functions
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidPostcode(postcode) {
            return /^[A-Z]{1,2}\d[A-Z\d]? \d[A-Z]{2}$/i.test(postcode);
        }

        // Simple heuristic to determine Mr./Ms. based on forename
        function getTitle(forename) {
            const commonFemaleNames = [
                "Diane", "Heidi", "Rushanara", "Rosena", "Fleur", "Victoria", "Catherine", "Olivia",
                "Harriett", "Antonia", "Jess", "Lorraine", "Apsana", "Alison", "Siân", "Polly", "Olivia",
                "Rachel", "Elsie", "Sarah", "Jade", "Sureena", "Karen", "Aphra", "Suella", "Jess", "Julia",
                "Maureen", "Dawn", "Ruth", "Nesil", "Irene", "Juliet", "Charlotte", "Wendy", "Sarah",
                "Bambos", "Ellie", "Feryal", "Carla", "Samantha", "Anneliese", "Helena", "Maria", "Sorcha",
                "Cat", "Lauren", "Sarah", "Maya", "Kirith", "Florence", "Kate", "Kate", "Miatta", "Linsey",
                "Natalie", "Emma", "Catherine", "Vicky", "Mary", "Zöe", "Gill", "Anna", "Sarah", "Lilian",
                "Nia", "Alison", "Amanda", "Louise", "Sarah", "Paulette", "Claire", "Monica", "Emma",
                "Carolyn", "Rebecca", "Helen", "Claire", "Pippa", "Meg", "Sharon", "Rachel", "Wera", "Natasha",
                "Sally", "Christine", "Liz", "Caroline", "Diana", "Kim", "Lillian", "Louise", "Ruth", "Sarah",
                "Satvir", "Alicia", "Liz", "Naushabah", "Jayne", "Gen", "Sonia", "Uma", "Laura", "Katie",
                "Abena", "Kate", "Kate", "Taiwo", "Sarah", "Priti", "Rebecca", "Stephanie", "Manuela", "Jess",
                "Bridget", "Ellie", "Rachel", "Joani", "Emma", "Bell", "Jenny", "Lucy", "Marie", "Anna", "Sarah",
                "Roz", "Liz", "Michelle", "Naz", "Tulip", "Vikki", "Lisa", "Cat", "Rebecca", "Sarah", "Karin",
                "Kirsteen", "Lauren", "Zarah", "Jo", "Elaine", "Susan", "Katrina", "Melanie", "Michelle",
                "Catherine", "Helen", "Jo", "Katie", "Nadia", "Munira", "Claire", "Yuan"
            ];
            return commonFemaleNames.includes(forename) ? "Ms." : "Mr.";
        }

        // Blur event listeners for validation
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const postcodeInput = document.getElementById('postcode');
        const policyInputs = document.querySelectorAll('input[name="policy"]');

        nameInput.addEventListener('blur', () => {
            if (!nameInput.value.trim()) {
                document.getElementById('nameError').classList.remove('hidden');
            } else {
                document.getElementById('nameError').classList.add('hidden');
            }
        });

        emailInput.addEventListener('blur', () => {
            const email = emailInput.value.trim();
            if (!email) {
                document.getElementById('emailError').textContent = 'Please enter your email address';
                document.getElementById('emailError').classList.remove('hidden');
            } else if (!isValidEmail(email)) {
                document.getElementById('emailError').textContent = 'Please enter a valid email address';
                document.getElementById('emailError').classList.remove('hidden');
            } else {
                document.getElementById('emailError').classList.add('hidden');
            }
        });

        postcodeInput.addEventListener('blur', () => {
            const postcode = postcodeInput.value.trim();
            if (!postcode) {
                document.getElementById('postcodeError').textContent = 'Please enter your postcode';
                document.getElementById('postcodeError').classList.remove('hidden');
            } else if (!isValidPostcode(postcode)) {
                document.getElementById('postcodeError').textContent = 'Please enter a valid UK postcode';
                document.getElementById('postcodeError').classList.remove('hidden');
            } else {
                document.getElementById('postcodeError').classList.add('hidden');
            }
        });

        // Fetch and parse CSV data
        let mpDataCache = null;
        let mpDataResult = null; // Store MP data for use in contact step

        async function fetchMpData() {
            if (mpDataCache) return mpDataCache;

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Failed to fetch CSV');
                const csvText = await response.text();

                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (result) => {
                            mpDataCache = result.data;
                            resolve(result.data);
                        },
                        error: (error) => reject(error)
                    });
                });
            } catch (error) {
                console.error('Error fetching or parsing CSV:', error);
                throw error;
            }
        }

        // Step 1: Find MP
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate policy selection
            const selectedPolicy = document.querySelector('input[name="policy"]:checked');
            if (!selectedPolicy) {
                document.getElementById('policyError').classList.remove('hidden');
                return;
            } else {
                document.getElementById('policyError').classList.add('hidden');
            }

            const postcode = document.getElementById('postcode').value;
            const apiKey = 'FncmgQEVdkSUE32UAMFKFsca'; // TODO: Secure this API key
            const apiUrl = `https://www.theyworkforyou.com/api/getMP?postcode=${postcode}&key=${apiKey}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                const mpName = data.full_name;
                const mpParty = data.party;
                const mpConstituency = data.constituency;
                mpDataResult = await getMpData(mpConstituency);

                mpDetails.textContent = `${mpName} (${mpParty}) - ${mpConstituency}`;
                mpInfo.classList.remove('hidden');
                contactMpButton.classList.remove('hidden');
                emailLinkContainer.classList.add('hidden'); // Hide email link until "Contact My MP" is clicked
            } catch (error) {
                console.error('Error fetching MP data:', error);
                mpDetails.textContent = 'Error fetching MP data. Please try again.';
                mpInfo.classList.remove('hidden');
                contactMpButton.classList.add('hidden');
            }
        });

        // Step 2: Contact MP
        contactMpButton.addEventListener('click', () => {
            if (!mpDataResult) {
                mpDetails.textContent = 'Please find your MP first.';
                return;
            }

            const userName = document.getElementById('name').value.trim();
            const selectedPolicy = document.querySelector('input[name="policy"]:checked').value;

            if (mpDataResult && mpDataResult.Email) {
                const mpTitle = getTitle(mpDataResult.Forename);
                const mpLastName = mpDataResult.Surname;
                const policy = selectedPolicy;
                const letter = letters[policy];
                const emailBody = encodeURIComponent(
                    `Dear ${mpTitle} ${mpLastName},\n\n${letter}\n\nSincerely,\n${userName}`
                );
                emailLink.href = `mailto:${mpDataResult.Email}?subject=Concerns%20about%20${encodeURIComponent(policy)}&body=${emailBody}`;
                emailLink.textContent = "Click here to email your MP";
                emailLinkContainer.classList.remove('hidden');
            } else {
                emailLink.textContent = "Email not available for this MP";
                emailLink.removeAttribute('href');
                emailLinkContainer.classList.remove('hidden');
            }
        });

        async function getMpData(constituency) {
            const mpData = await fetchMpData();
            const normalizedConstituency = constituency.toLowerCase().trim();
            for (const row of mpData) {
                const normalizedCsvConstituency = row.Constituency.toLowerCase().trim();
                if (normalizedCsvConstituency === normalizedConstituency) {
                    return {
                        Forename: row.Forename,
                        Surname: row.Surname,
                        Email: row.Email
                    };
                }
            }
            return null;
        }
    </script>
</body>
</html>
