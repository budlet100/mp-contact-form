<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP Contact Form - Bitcoin Policy </title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-2 text-orange-700">Contact Your MP About XYZ </h1>
        <p class="text-gray-600 mb-6">Make your voice heard </p>

        <form id="mpContactForm" class="space-y-6">
            <!-- Personal Information Section -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">Your Information</h2>
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Full Name *</label>
                        <input type="text" id="name" name="name" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 px-3 py-2"
                            placeholder="Your full name">
                        <p id="nameError" class="hidden text-red-500 text-sm mt-1">Please enter your full name</p>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address *</label>
                        <input type="email" id="email" name="email" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 px-3 py-2"
                            placeholder="your.email@example.com">
                        <p id="emailError" class="hidden text-red-500 text-sm mt-1">Please enter a valid email address</p>
                    </div>

                    <div>
                        <label for="postcode" class="block text-sm font-medium text-gray-700">Postcode *</label>
                        <input type="text" id="postcode" name="postcode" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 px-3 py-2"
                            placeholder="e.g., SW1A 1AA">
                        <p id="postcodeError" class="hidden text-red-500 text-sm mt-1">Please enter a valid UK postcode</p>
                    </div>
                </div>
            </div>

            <!-- MP Information Display -->
            <div id="mpInfo" class="hidden bg-orange-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Your MP</h2>
                <p id="mpDetails" class="text-gray-800"></p>
            </div>

            <!-- Message Preview -->
            <div id="messagePreview" class="hidden bg-gray-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Your Message Preview</h2>
                <div id="previewText" class="text-gray-800 whitespace-pre-line bg-white p-4 rounded border"></div>
            </div>

            <!-- GDPR Consent -->
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="flex items-start">
                    <div class="flex items-center h-5">
                        <input id="gdprConsent" name="gdprConsent" type="checkbox" required
                            class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="gdprConsent" class="font-medium text-gray-700">GDPR Consent *</label>
                        <p class="text-gray-500">I consent to my personal data being processed for the purpose of contacting my MP. 
                            This data will not be shared with third parties or used for any other purpose.</p>
                    </div>
                </div>
                <p id="gdprError" class="hidden text-red-500 text-sm mt-1">Please accept the GDPR consent to proceed</p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitButton"
                class="w-full bg-orange-600 text-white py-3 px-4 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors disabled:bg-gray-400">
                Contact My MP
            </button>
        </form>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto"></div>
                <p class="mt-4 text-gray-700">Looking up your MP...</p>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('mpContactForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const submitButton = document.getElementById('submitButton');
        const mpInfo = document.getElementById('mpInfo');
        const mpDetails = document.getElementById('mpDetails');
        const messagePreview = document.getElementById('previewText');
        const postcodeRegex = /^[A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2}$/i;

        // Form validation
        async function validateInput() {
            let isValid = true;
            
            // Name validation
            const name = document.getElementById('name').value.trim();
            if (name.length < 2) {
                document.getElementById('nameError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('nameError').classList.add('hidden');
            }

            // Email validation
            const email = document.getElementById('email').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('emailError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('emailError').classList.add('hidden');
            }

            // Postcode validation
            const postcode = document.getElementById('postcode').value.trim();
            if (!postcodeRegex.test(postcode)) {
                document.getElementById('postcodeError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('postcodeError').classList.add('hidden');
            }

            // GDPR consent validation
            const gdprConsent = document.getElementById('gdprConsent').checked;
            if (!gdprConsent) {
                document.getElementById('gdprError').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('gdprError').classList.add('hidden');
            }

            return isValid;
        }

        function updateMessagePreview(name, mpName) {
            const message = `Dear ${mpName},

I am writing to you as a concerned constituent regarding the urgent matter of climate change. As your constituent, I believe it is crucial that our community takes a leading role in addressing this global crisis.

Key points I would like to raise:

1. The need for ambitious local and national climate targets
2. Support for renewable energy initiatives in our constituency
3. Investment in orange public transport and cycling infrastructure
4. Protection of local orange spaces and biodiversity
5. Support for home insulation and energy efficiency programs

I would appreciate your views on these matters and would like to know what specific actions you are taking to address climate change in our constituency.

I look forward to your response.

Yours sincerely,
${name}`;

            messagePreview.textContent = message;
            document.getElementById('messagePreview').classList.remove('hidden');
        }

async function lookupMP(postcode) {
    const apiKey = 'FncmgQEVdkSUE32UAMFKFsca';
    // Modified API endpoint format
    const url = `https://www.theyworkforyou.com/api/getMP?postcode=${encodeURIComponent(postcode)}&key=${apiKey}&output=json`;
    
    try {
        console.log('Fetching MP data for postcode:', postcode); // Debug log
        const response = await fetch(url);
        console.log('API Response:', response); // Debug log
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Parsed data:', data); // Debug log

        if (data.error) {
            throw new Error(data.error);
        }

        // Modified to handle the correct response format
        return {
            name: data.full_name || data.name,
            email: data.email || data.office_email,
            constituency: data.constituency
        };

    } catch (error) {
        console.error('Error during MP lookup:', error);
        throw new Error(error.message || 'Unable to find MP information. Please check your postcode.');
    }
}

        // Form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!await validateInput()) {
                return;
            }

            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const postcode = document.getElementById('postcode').value.trim();

            loadingOverlay.classList.remove('hidden');
            submitButton.disabled = true;

            try {
                const mp = await lookupMP(postcode);
                
                if (!mp.email) {
                    throw new Error("MP's email address is not available. Please contact your MP through their website.");
                }

                mpDetails.textContent = `${mp.name} (${mp.constituency})`;
                mpInfo.classList.remove('hidden');

                updateMessagePreview(name, mp.name);

                const subject = 'Constituent Contact Regarding Climate Action';
                const mailtoLink = `mailto:${mp.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(messagePreview.textContent)}`;
                
                setTimeout(() => {
                    window.location.href = mailtoLink;
                }, 500);

            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4';
                errorDiv.role = 'alert';
                errorDiv.innerHTML = `
                    <strong class="font-bold">Error: </strong>
                    <span class="block sm:inline">${error.message}</span>
                `;
                
                form.insertAdjacentElement('beforebegin', errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            } finally {
                loadingOverlay.classList.add('hidden');
                submitButton.disabled = false;
            }
        });

        // Debounced postcode validation
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Real-time postcode validation
        const postcodeInput = document.getElementById('postcode');
        postcodeInput.addEventListener('input', debounce((e) => {
            const postcode = e.target.value.trim();
            const postcodeError = document.getElementById('postcodeError');
            
            if (postcode && !postcodeRegex.test(postcode)) {
                postcodeError.classList.remove('hidden');
            } else {
                postcodeError.classList.add('hidden');
            }
        }, 500));
    </script>
</body>
</html>
